This repository contains initial setup instructions to use [DLProf](https://docs.nvidia.com/deeplearning/frameworks/dlprof-user-guide/) with PyTorch NGC on [JUWELS](https://apps.fz-juelich.de/jsc/hps/juwels/configuration.html) for a MNIST PyTorch example. 

**Disclaimer** : This repository is intended to be only the first step in exploring DLProf

**Deep Learning Profiler (DLProf)** is profiling tool for deep learning models. It has two parts CLI and Viewer:
- The **CLI (dlprof)** uses Nsight Systems profiler under the hood to aggregate and correlate CPU AND GPU profiling data from training run. It is able to give Tensor Core usage for operations and kernerls as well as provide recommendations via Expert Systems for identified performance issues.
- The **Viewer (dlprofviewer)** provides visualization for the data from DLProf CLI.

## Setup 

Execute the following steps in JUWELS to pull the PyTorch NGC container :
```
ml load Apptainer-Tools
apptainer pull docker://nvcr.io/nvidia/pytorch:21.11-py3
```

If you want to enable `tensorboardX` for logging then pip install in the PyTorch NGC container as
```
apptainer run pytorch-21.11-py3.sif
pip install tensorboardX

```


## Code Additions 

The `mnist_train.py` contains the following additions to use DLProf

- Import the Nvidia Tools Extension (NVTX) as 
    ```
    import nvidia_dlprof_pytorch_nvtx as nvtx `
    ```
- add `dlprof` as parser arguement
- Initialize dlprof as 
    ```
    nvtx.init(enable_function_stack=True)      
    ```
- Run training loop with 
    ```
    with torch.autograd.profiler.emit_nvtx():
        <train loop >
    ```


## Run DLProf inside PyTorch NGC

Execute the `jobscript.sh` after modifying the `SBATCH` variables as :

```
sbatch jobscript.sh
```
to launch the container and run DLProf with python command like 

` dlprof --mode pytorch --reports=summary --iter_start=200 --iter_stop=400 python <PyT script> ` 

Other arguements for dlprof can be found [here](https://docs.nvidia.com/deeplearning/frameworks/dlprof-user-guide/index.html#command-line-ags)

DLProf automatically creates the correct Nsight System command line needed to profile training session and creates the DLProf database needed to view the results in the DLProf Viewer. 
The following files are created:
- `nsys_profile.qdrep` : The QDREP file is generated by Nsight Systems and can be opened in the Nsight Systems GUI to view the timeline of the profile.
- `nsys_profile.sqlite` : A SQLite database of the profile data that is used by DLprof.
- `dlprof_dldb.sqlite`: The DLProf database which contains the aggregated statistic from the run.

Additionaly in the output log you can see the Expert Systems Feedback.


## Using a Python Virtual Envirionment to launch DLProf Viewer

In JUWELS you need to set up a python venv to launch the DLProf Viewer. It can be done as follows:

```
python -m venv ./env --prompt dlprof
source env/bin/activate
pip install nvidia-pyindex
pip install nvidia-dlprofviewer

```
Launch the DLProf Viewer

```
dlprofviewer dlprof_dldb.sqlite 

```
